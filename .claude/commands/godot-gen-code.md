---
name: godot-gen-code
description: 协作式 Godot 代码生成器
argument-hint: "[编码任务描述]"
---

## 功能说明

采用人机协作的方式完成 Godot 项目编码任务，通过智能任务分解、责任划分和质量控制，确保代码质量和开发效率。

## 执行步骤

1. **任务验证**：
   - 检查用户是否提供了编码任务描述参数
   - 如未提供参数，提示用户详细描述需要完成的编码任务

2. **设计文档检索**：
   - 搜索项目中 `/docs` 目录下的相关设计文档
   - 查找与编码任务 $ARGUMENTS 匹配的现有设计方案

3. **Agent协调架构设计**：
   - **架构分析**: 使用Task工具启动godot-architect代理进行架构设计
     - 分析编码任务 $ARGUMENTS 的技术需求和架构要求
     - 设计符合SOLID原则的模块化架构方案
     - 提供详细的组件划分和接口定义
     - 输出标准化的架构设计文档
   - **方案确认**: 向用户展示架构方案核心思路，请求确认
   - **方案优化**: 如用户不认可，重新设计直到用户满意
   - **设计记录**: 将架构方案记录到memory中供后续开发参考

4. **Agent协调任务分解**：
   - **任务分解**: 继续使用godot-architect进行任务分解和规划
     - 将整体架构方案分解为具体可执行的子任务
     - 分析任务间的依赖关系，制定最优执行顺序
     - 识别每个任务的技术复杂度和实现难点
   - **责任分配**: 基于任务性质进行智能责任划分
     - **逻辑实现任务**: 分配给godot-game-developer
     - **代码质量任务**: 分配给senior-code-reviewer
     - **文档生成任务**: 分配给design-doc-writer
     - **用户交互任务**: 明确标记为用户负责

5. **多Agent协作执行规划**：
   - **执行序列**: 生成详细的多agent协作执行序列
   - **依赖管理**: 明确agent间的协作依赖和数据传递
   - **质量关卡**: 在关键节点设置质量检查点
   - **用户介入点**: 标识需要用户确认和操作的节点

6. **Agent协同开发执行**：
   - **智能代码实现策略**:
     * **任务复杂度评估**: 根据编码任务的复杂度和类型智能选择实现agent
       - **简单逻辑实现**（<100行，基础功能）: 使用local-developer(qwen3-coder:30b)高效实现
       - **中等复杂任务**（100-300行，多个组件）: local-developer + godot-game-developer协作
       - **复杂架构任务**（>300行，复杂系统）: godot-game-developer主导 + local-developer辅助
       - **性能关键代码**: godot-game-developer + senior-code-reviewer双重验证
     * **分层实现方法**:
       - Claude Code: 生成代码框架、架构设计和核心接口
       - local-developer: 填充具体实现、编写方法和函数逻辑
       - godot-game-developer: 处理游戏特定的复杂逻辑和架构
   - **代码实现阶段**:
     * **框架生成**: Claude Code生成整体代码框架和架构设计
     * **具体实现**: 使用Task工具启动local-developer编写GDScript代码具体实现
       - 严格按照架构设计进行代码实现
       - 遵循 `gdscript编码规范` 和最佳实践
       - 为每个任务生成完整的可执行代码
     * **专业验证**: 对于复杂逻辑，使用godot-game-developer进行专业验证
   - **质量保证阶段**:
     * **本地质量检查**: local-developer进行基础的代码质量检查
     * **专业代码审查**: 每个代码任务完成后，启动senior-code-reviewer进行深度审查
       - 验证代码质量、性能和安全性
       - 检查是否符合架构设计和编码规范
       - 消除代码异味和潜在问题
     * **Godot专业审查**: 对于游戏逻辑，使用godot-game-developer进行专业审查
   - **文档化阶段**:
     * 使用design-doc-writer生成任务文档和API文档
     * 输出详细的操作指南和配置说明
     * 将文档保存到 `docs/tasks/` 目录

7. **用户协作与任务管理**：
   - **用户任务生成**: 为用户负责的任务生成详细说明文档
     * 使用design-doc-writer创建清晰的任务指南
     * 提供具体的操作步骤、工具使用和完成标准
     * 包含截图、示例和故障排除指南
   - **协作节点管理**: 在用户任务节点暂停执行
     * 等待用户确认任务完成
     * 验证用户完成结果的质量
     * 记录用户反馈和改进建议
   - **进度跟踪**: 维护整体任务进度和状态
     * 更新memory中的任务执行状态
     * 跟踪agent协作过程和关键决策

8. **集成测试与质量验证**：
   - **功能集成**: 使用godot工具进行整体功能测试
   - **性能验证**: 运行性能测试确保达到预期标准
   - **代码审查**: 启动senior-code-reviewer进行最终代码审查
   - **用户验收**: 向用户展示完整功能并请求验收确认

9. **知识沉淀与优化**：
   - **经验总结**: 将开发过程中的经验和最佳实践记录到memory
   - **模式提取**: 提取成功的开发模式和协作流程
   - **模板创建**: 为类似任务创建可复用的模板和规范
   - **持续优化**: 基于用户反馈持续改进协作流程

## 协作模式

### 责任划分

#### Claude Code 职责（架构设计）
- **系统架构设计**：设计模块化的代码结构和接口
- **任务分解规划**：将复杂需求分解为可执行的子任务
- **代码框架生成**：生成代码的总体框架和核心结构
- **质量标准制定**：制定代码质量标准和审查规范

#### local-developer 职责（具体实现）
- **GDScript代码实现**：编写具体的函数、方法和类实现
- **基础逻辑编写**：实现简单到中等复杂的游戏逻辑
- **代码细节填充**：填充框架中的具体实现细节
- **基础代码优化**：进行基础的代码优化和重构

#### godot-game-developer 职责（专业游戏逻辑）
- **复杂游戏机制**：实现复杂的游戏系统和机制
- **性能优化代码**：编写性能关键的代码片段
- **Godot最佳实践**：应用Godot引擎的专业最佳实践
- **高级功能实现**：实现需要深入Godot知识的功能

#### 用户职责（视觉与配置）
- **场景细化**：调整和完善 tscn 文件的视觉表现
- **动画制作**：使用资源资产创建游戏动画效果
- **视觉元素**：创建 Sprite、设置碰撞体、配置视觉效果
- **资源管理**：配置字体、颜色、材质等视觉资源
- **项目设置**：调整项目配置和优化设置

### 开发原则

1. **小步前进**：将复杂任务分解为小步骤，逐步实现和验证
2. **SOLID 原则**：
   - **单一职责**：每个类和函数只负责一个明确的功能
   - **开闭原则**：对扩展开放，对修改封闭
   - **里氏替换**：子类可以替换父类而不影响程序正确性
   - **接口隔离**：使用小而专一的接口，避免臃肿的接口
   - **依赖倒置**：依赖抽象而非具体实现
3. **DRY 原则**：避免代码重复，提高代码的可维护性

## GDScript 编码规范

### 基础规范

#### 文件格式
- **编码**：使用不带 BOM 的 UTF-8 编码
- **换行符**：统一使用 LF（\n）换行，避免使用 CRLF 或 CR
- **文件结尾**：每个文件末尾必须包含一个换行符
- **缩进**：使用制表符（Tab）而非空格进行缩进

#### 代码结构
- **函数与类定义**：用两个空行包围函数和类定义
- **续行缩进**：使用 2 个额外的缩进级别区分续行代码块
- **数组/字典/枚举**：作为例外，仅使用单个缩进级别

#### 命名约定
- **未使用参数**：函数签名中未使用的参数以 `_` 开头
- **自注释代码**：优先使用清晰的命名替代注释
- **日志输出**：避免使用 `print()` 打印日志

### 代码示例

#### 正确的缩进示例
```gdscript
# 基本缩进
for i in range(10):
	pass

# 续行缩进
effect.interpolate_property(sprite, "transform/scale",
		sprite.get_scale(), Vector2(2.0, 2.0), 0.3,
		Tween.TRANS_QUAD, Tween.EASE_OUT)

# 数组/字典续行
var positions = [
	Vector2(0, 0),
	Vector2(100, 50),
	Vector2(-50, 75)
]
```

#### 错误的缩进示例
```gdscript
# 缩进不足
for i in range(10):
print("hello")

# 缩进过度
for i in range(10):
		print("hello")

# 续行缩进不足
effect.interpolate_property(sprite, "transform/scale",
	sprite.get_scale(), Vector2(2.0, 2.0), 0.3,
	Tween.TRANS_QUAD, Tween.EASE_OUT)
```