---
name: smart-commit
description: 智能代码变更分析和 commit 消息生成器
argument-hint: "[commit类型或自定义描述]"
---

## 功能说明

智能分析项目代码变更，自动生成符合规范的 commit 消息，支持多种 commit 类型和自定义描述。

## 执行步骤

### 1. 初始化和环境检查
- 检查当前目录是否为 Git 仓库
- 验证是否有未提交的变更
- 确认工作区状态（staged/unstaged 文件）

### 2. 变更分析和收集
- **Git 状态分析**：
  - 使用 `git status --porcelain` 获取详细的变更状态
  - 识别新增、修改、删除、重命名的文件
  - 区分已暂存和未暂存的变更

- **变更内容深度分析**：
  - 使用 `git diff --staged` 分析已暂存的变更
  - 使用 `git diff` 分析未暂存的变更
  - 重点关注以下文件类型：
    - 配置文件（`.json`, `.yaml`, `.toml`, `.env`）
    - 代码文件（`.js`, `.ts`, `.py`, `.gd`, `.cs` 等）
    - 文档文件（`.md`, `.txt`, `.rst`）
    - 构建文件（`Dockerfile`, `Makefile`, 构建脚本）

### 3. 智能分类和影响评估
- **智能变更检测策略**:
  - **简单变更（<10个文件，基础修改）**: 使用local-developer进行快速分析
  - **中等变更（10-50个文件，功能模块）**: local-developer + 智能分析组合
  - **复杂变更（>50个文件，重大更新）**: 全面分析 + 专业验证

- **变更类型识别**：
  - **feat**: 新功能、新特性
  - **fix**: Bug 修复、错误纠正
  - **docs**: 文档更新、README 修改
  - **style**: 代码格式化、样式调整（不影响功能）
  - **refactor**: 代码重构、内部优化
  - **perf**: 性能优化、速度提升
  - **test**: 测试相关、测试用例
  - **chore**: 构建过程、依赖管理、工具配置
  - **ci**: CI/CD 配置、自动化流程

- **影响范围分析**：
  - **核心功能**: 影响主要业务逻辑
  - **配置变更**: 影响系统配置或环境设置
  - **依赖更新**: 包管理器文件变更
  - **文档完善**: 文档结构或内容更新

### 4. 智能消息生成
- **分层分析策略**:
  - **基础分析**: local-developer(qwen3-coder:30b)进行快速的代码语义分析
    - 分析变更文件的基本类型和功能
    - 识别简单的代码模式和函数修改
    - 生成基础的commit消息建议
  - **深度分析**: 对于复杂变更使用更深入的分析
    - 分析架构变更和设计模式修改
    - 识别跨文件的系统性变更
    - 评估变更的影响范围和重要性

- **自动分析生成**：
  - 基于变更文件路径和内容智能推断变更目的
  - 分析代码变更的语义和影响范围
  - 生成简洁明了的 commit 标题（50字符以内）
  - 提供详细的变更描述（如有必要）

- **消息模板应用**：
  ```
  <type>(<scope>): <subject>
  
  <body>
  
  <footer>
  ```

- **具体生成规则**：
  - **配置文件变更**：识别配置项的具体变化
  - **代码功能变更**：分析函数/类的修改目的
  - **文档更新**：识别文档类型的变更
  - **依赖管理**：识别包版本和依赖关系变化

### 5. 交互式确认和优化
- **预览展示**：
  - 展示检测到的所有变更文件
  - 显示生成的 commit 消息预览
  - 提供变更统计信息（文件数量、代码行数变化）

- **用户交互**：
  - 询问是否接受自动生成的 commit 消息
  - 提供修改建议和选项：
    - 修改 commit 类型
    - 调整影响范围
    - 重写 commit 描述
    - 添加详细说明
  - 支持自定义 commit 消息

### 6. 执行 commit 操作
- **安全检查**：
  - 确认没有敏感信息泄露
  - 验证 commit 消息格式规范
  - 检查是否有大文件或二进制文件意外提交

- **执行提交**：
  - 根据用户确认执行 `git commit`
  - 使用生成的或确认的 commit 消息
  - **重要：生成纯净的commit消息，不包含任何AI工具标识**
  - 提供执行结果反馈

## 重要说明

**执行commit时严格禁止添加以下自动生成标识：**
- 🤖 Generated with [Claude Code](https://claude.com/claude-code)
- Co-Authored-By: Claude <noreply@anthropic.com>
- 任何其他AI工具的自动生成标记

commit消息应该保持简洁、专业，只包含实际的变更描述，不包含工具使用痕迹。

### 7. 高级功能
- **批量提交处理**：
  - 支持将不同类型的变更分组提交
  - 建议最佳的提交策略
  - 对于大型变更，使用local-developer分析提交分组策略

- **历史记录分析**：
  - 分析项目的 commit 历史，保持风格一致
  - 学习项目的 commit 消息模式
  - 使用local-developer快速匹配历史模式

- **智能建议**：
  - 建议是否需要拆分大的 commit
  - 推荐合适的 commit 类型
  - 提供最佳实践建议
  - 对于代码质量相关的变更，使用local-developer提供技术建议

## 使用示例

### 自动分析和提交
```bash
/smart-commit
```
- 自动分析所有变更
- 生成合适的 commit 消息
- 交互式确认后提交

### 指定 commit 类型
```bash
/smart-commit feat
```
- 强制使用 feat 类型
- 其他参数自动分析

### 自定义描述
```bash
/smart-commit "添加用户认证功能"
```
- 使用用户提供的描述
- 自动补充其他信息

## 特殊文件处理规则

### 配置文件
- **package.json**: 识别依赖版本变化、脚本更新
- **tsconfig.json**: TypeScript 配置调整
- **Dockerfile**: 容器配置变更
- **.env**: 环境变量配置（需安全检查）

### 代码文件
- **核心业务逻辑**: 识别功能变更类型
- **测试文件**: 自动归类为 test 类型
- **工具脚本**: 归类为 chore 类型

### 文档文件
- **README.md**: 项目文档更新
- **API 文档**: 接口文档变更
- **代码注释**: 内联文档更新

## 质量保证

- **格式规范**: 遵循 Conventional Commits 规范
- **内容准确**: 确保消息与实际变更一致
- **安全性**: 防止敏感信息泄露
- **可读性**: 生成清晰易懂的 commit 消息